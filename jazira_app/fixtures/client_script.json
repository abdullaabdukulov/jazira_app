[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Jazira App Daily Sales Import",
  "enabled": 1,
  "modified": "2026-01-03 19:05:09.413351",
  "module": "Jazira App",
  "name": "Jazira App Daily Sales Import",
  "script": "frappe.ui.form.on('Restaurant Daily Sales Import', {\r\n    \r\n    // =================================================================\r\n    // REFRESH EVENT\r\n    // =================================================================\r\n    \r\n    refresh: function(frm) {\r\n        // Add custom buttons based on status\r\n        frm.trigger('setup_buttons');\r\n        \r\n        // Setup real-time listeners\r\n        frm.trigger('setup_realtime');\r\n        \r\n        // Show status indicator\r\n        frm.trigger('show_status_indicator');\r\n        \r\n        // Set filters for warehouse\r\n        frm.trigger('set_warehouse_filter');\r\n    },\r\n    \r\n    // =================================================================\r\n    // FIELD EVENTS\r\n    // =================================================================\r\n    \r\n    company: function(frm) {\r\n        // Clear warehouse when company changes\r\n        frm.set_value('source_warehouse', '');\r\n        frm.trigger('set_warehouse_filter');\r\n    },\r\n    \r\n    source_warehouse: function(frm) {\r\n        frm.trigger('validate_prerequisites');\r\n    },\r\n    \r\n    posting_date: function(frm) {\r\n        frm.trigger('validate_prerequisites');\r\n    },\r\n    \r\n    excel_file: function(frm) {\r\n        if (frm.doc.excel_file) {\r\n            frm.trigger('on_excel_uploaded');\r\n        }\r\n    },\r\n    \r\n    // =================================================================\r\n    // CUSTOM TRIGGERS\r\n    // =================================================================\r\n    \r\n    set_warehouse_filter: function(frm) {\r\n        frm.set_query('source_warehouse', function() {\r\n            return {\r\n                filters: {\r\n                    'company': frm.doc.company || '',\r\n                    'is_group': 0\r\n                }\r\n            };\r\n        });\r\n    },\r\n    \r\n    validate_prerequisites: function(frm) {\r\n        // Disable excel_file field if prerequisites not met\r\n        let valid = frm.doc.company && frm.doc.source_warehouse && frm.doc.posting_date;\r\n        \r\n        if (!valid) {\r\n            frm.set_df_property('excel_file', 'read_only', 1);\r\n            frm.set_df_property('excel_file', 'description', \r\n                '<span style=\"color: red;\">Avval Company, Warehouse va Posting Date tanlang!</span>');\r\n        } else {\r\n            frm.set_df_property('excel_file', 'read_only', 0);\r\n            frm.set_df_property('excel_file', 'description', \r\n                'POS hisoboti Excel fayli (.xlsx)');\r\n        }\r\n    },\r\n    \r\n    on_excel_uploaded: function(frm) {\r\n        if (frm.doc.status !== 'Draft') {\r\n            frappe.msgprint(__('Import allaqachon bajarilgan'));\r\n            return;\r\n        }\r\n        \r\n        // Auto-save and show preview\r\n        frm.save().then(() => {\r\n            frm.trigger('show_preview');\r\n        });\r\n    },\r\n    \r\n    setup_buttons: function(frm) {\r\n        // Clear existing buttons\r\n        frm.clear_custom_buttons();\r\n        \r\n        if (frm.doc.status === 'Draft') {\r\n            if (frm.doc.excel_file) {\r\n                // Preview button\r\n                frm.add_custom_button(__('üìã Preview'), function() {\r\n                    frm.trigger('show_preview');\r\n                }, __('Actions'));\r\n                \r\n                // Validate button\r\n                frm.add_custom_button(__('‚úì Validate'), function() {\r\n                    frm.trigger('validate_items');\r\n                }, __('Actions'));\r\n                \r\n                // Process button (primary)\r\n                frm.add_custom_button(__('‚ñ∂ Process Import'), function() {\r\n                    frm.trigger('process_import');\r\n                }).addClass('btn-primary');\r\n            }\r\n        }\r\n        \r\n        if (frm.doc.status === 'Processed') {\r\n            // Cancel button\r\n            frm.add_custom_button(__('‚úï Cancel Import'), function() {\r\n                frm.trigger('cancel_import');\r\n            }).addClass('btn-danger');\r\n            \r\n            // View Sales Invoice\r\n            if (frm.doc.sales_invoice) {\r\n                frm.add_custom_button(__('Sales Invoice'), function() {\r\n                    frappe.set_route('Form', 'Sales Invoice', frm.doc.sales_invoice);\r\n                }, __('View'));\r\n            }\r\n            \r\n            // View Stock Entry\r\n            if (frm.doc.stock_entry) {\r\n                frm.add_custom_button(__('Stock Entry'), function() {\r\n                    frappe.set_route('Form', 'Stock Entry', frm.doc.stock_entry);\r\n                }, __('View'));\r\n            }\r\n        }\r\n        \r\n        if (frm.doc.status === 'Failed') {\r\n            // Retry button\r\n            frm.add_custom_button(__('üîÑ Retry'), function() {\r\n                frm.set_value('status', 'Draft');\r\n                frm.save().then(() => {\r\n                    frm.trigger('process_import');\r\n                });\r\n            }).addClass('btn-warning');\r\n        }\r\n    },\r\n    \r\n    show_status_indicator: function(frm) {\r\n        let status_colors = {\r\n            'Draft': 'blue',\r\n            'Processing': 'orange',\r\n            'Processed': 'green',\r\n            'Failed': 'red'\r\n        };\r\n        \r\n        let color = status_colors[frm.doc.status] || 'gray';\r\n        frm.page.set_indicator(__(frm.doc.status), color);\r\n    },\r\n    \r\n    setup_realtime: function(frm) {\r\n        // Listen for import success\r\n        frappe.realtime.on('restaurant_import_success', function(data) {\r\n            if (data.doc_name === frm.doc.name) {\r\n                frappe.show_alert({\r\n                    message: __('Import muvaffaqiyatli bajarildi!'),\r\n                    indicator: 'green'\r\n                });\r\n                frm.reload_doc();\r\n            }\r\n        });\r\n        \r\n        // Listen for import failure\r\n        frappe.realtime.on('restaurant_import_failed', function(data) {\r\n            if (data.doc_name === frm.doc.name) {\r\n                frappe.msgprint({\r\n                    title: __('Import xatosi'),\r\n                    indicator: 'red',\r\n                    message: data.error\r\n                });\r\n                frm.reload_doc();\r\n            }\r\n        });\r\n    },\r\n    \r\n    // =================================================================\r\n    // ACTION HANDLERS\r\n    // =================================================================\r\n    \r\n    show_preview: function(frm) {\r\n        frappe.call({\r\n            method: 'restaurant.restaurant.doctype.restaurant_daily_sales_import.restaurant_daily_sales_import.get_preview_data',\r\n            args: {\r\n                doc_name: frm.doc.name\r\n            },\r\n            freeze: true,\r\n            freeze_message: __('Excel o\\'qilmoqda...'),\r\n            callback: function(r) {\r\n                if (r.message && r.message.success) {\r\n                    frm.trigger('render_preview_dialog', r.message);\r\n                } else {\r\n                    frappe.msgprint({\r\n                        title: __('Xato'),\r\n                        indicator: 'red',\r\n                        message: r.message ? r.message.message : __('Preview yuklashda xato')\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    },\r\n    \r\n    render_preview_dialog: function(frm, data) {\r\n        let items = data.items || [];\r\n        let summary = data.summary || {};\r\n        \r\n        // Build HTML table\r\n        let rows_html = items.map((item, idx) => {\r\n            let status_badge = item.found \r\n                ? `<span class=\"badge badge-success\">${item.type}</span>`\r\n                : `<span class=\"badge badge-danger\">TOPILMADI</span>`;\r\n            \r\n            let bom_badge = item.has_bom \r\n                ? `<span class=\"badge badge-info\" title=\"${item.bom}\">BOM</span>` \r\n                : '';\r\n            \r\n            return `\r\n                <tr class=\"${item.found ? '' : 'bg-danger text-white'}\">\r\n                    <td>${idx + 1}</td>\r\n                    <td>${item.row_num}</td>\r\n                    <td>${item.item_name}</td>\r\n                    <td>${item.item_code || '-'}</td>\r\n                    <td class=\"text-right\">${item.qty}</td>\r\n                    <td class=\"text-right\">${format_currency(item.rate, 'UZS')}</td>\r\n                    <td class=\"text-right\">${format_currency(item.qty * item.rate, 'UZS')}</td>\r\n                    <td>${status_badge} ${bom_badge}</td>\r\n                </tr>\r\n            `;\r\n        }).join('');\r\n        \r\n        let dialog = new frappe.ui.Dialog({\r\n            title: __('Excel Preview'),\r\n            size: 'extra-large',\r\n            fields: [\r\n                {\r\n                    fieldtype: 'HTML',\r\n                    fieldname: 'preview_html'\r\n                }\r\n            ]\r\n        });\r\n        \r\n        let html = `\r\n            <div class=\"mb-4\">\r\n                <div class=\"row\">\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"stat-card bg-primary text-white p-3 rounded\">\r\n                            <h3>${summary.total_items || 0}</h3>\r\n                            <small>Jami qatorlar</small>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"stat-card bg-success text-white p-3 rounded\">\r\n                            <h3>${summary.found || 0}</h3>\r\n                            <small>Topildi</small>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"stat-card bg-danger text-white p-3 rounded\">\r\n                            <h3>${summary.not_found || 0}</h3>\r\n                            <small>Topilmadi</small>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"col-md-3\">\r\n                        <div class=\"stat-card bg-info text-white p-3 rounded\">\r\n                            <h3>${format_currency(summary.total_amount || 0, 'UZS')}</h3>\r\n                            <small>Jami summa</small>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"mb-3\">\r\n                <span class=\"badge badge-primary mr-2\">Taomlar (BOM): ${summary.dishes || 0}</span>\r\n                <span class=\"badge badge-secondary\">Ichimliklar: ${summary.drinks || 0}</span>\r\n            </div>\r\n            \r\n            <div class=\"table-responsive\" style=\"max-height: 400px; overflow-y: auto;\">\r\n                <table class=\"table table-sm table-bordered table-hover\">\r\n                    <thead class=\"thead-dark sticky-top\">\r\n                        <tr>\r\n                            <th>#</th>\r\n                            <th>Excel Row</th>\r\n                            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>\r\n                            <th>Item Code</th>\r\n                            <th class=\"text-right\">Qty</th>\r\n                            <th class=\"text-right\">Rate</th>\r\n                            <th class=\"text-right\">Amount</th>\r\n                            <th>Status</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        ${rows_html}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        `;\r\n        \r\n        dialog.fields_dict.preview_html.$wrapper.html(html);\r\n        dialog.show();\r\n    },\r\n    \r\n    validate_items: function(frm) {\r\n        frappe.call({\r\n            method: 'restaurant.restaurant.doctype.restaurant_daily_sales_import.restaurant_daily_sales_import.validate_excel_items',\r\n            args: {\r\n                doc_name: frm.doc.name\r\n            },\r\n            freeze: true,\r\n            freeze_message: __('Tekshirilmoqda...'),\r\n            callback: function(r) {\r\n                if (r.message) {\r\n                    let data = r.message;\r\n                    \r\n                    if (data.success) {\r\n                        frappe.msgprint({\r\n                            title: __('Validation Success'),\r\n                            indicator: 'green',\r\n                            message: `\r\n                                <p><strong>${data.items.length}</strong> ta item topildi</p>\r\n                                <p>Jami: <strong>${format_currency(data.total_amount, 'UZS')}</strong></p>\r\n                            `\r\n                        });\r\n                    } else {\r\n                        let errors_html = (data.errors || []).map(e => \r\n                            `<li>Qator ${e.row}: ${e.error}</li>`\r\n                        ).join('');\r\n                        \r\n                        frappe.msgprint({\r\n                            title: __('Validation Errors'),\r\n                            indicator: 'red',\r\n                            message: `<ul>${errors_html}</ul>`\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    },\r\n    \r\n    process_import: function(frm) {\r\n        // Confirm dialog\r\n        frappe.confirm(\r\n            __(`Import bajarilsinmi?<br><br>\r\n                <strong>Company:</strong> ${frm.doc.company}<br>\r\n                <strong>Warehouse:</strong> ${frm.doc.source_warehouse}<br>\r\n                <strong>Date:</strong> ${frm.doc.posting_date}<br><br>\r\n                <em>Bu jarayon Sales Invoice va Stock Entry yaratadi.</em>\r\n            `),\r\n            function() {\r\n                // On Yes\r\n                frappe.call({\r\n                    method: 'restaurant.restaurant.doctype.restaurant_daily_sales_import.restaurant_daily_sales_import.process_import',\r\n                    args: {\r\n                        doc_name: frm.doc.name,\r\n                        background: false  // Set to true for large files\r\n                    },\r\n                    freeze: true,\r\n                    freeze_message: __('Import jarayoni...'),\r\n                    callback: function(r) {\r\n                        if (r.message) {\r\n                            let result = r.message;\r\n                            \r\n                            if (result.success) {\r\n                                frappe.show_alert({\r\n                                    message: __('Import muvaffaqiyatli!'),\r\n                                    indicator: 'green'\r\n                                });\r\n                                \r\n                                frappe.msgprint({\r\n                                    title: __('Import natijasi'),\r\n                                    indicator: 'green',\r\n                                    message: `\r\n                                        <p>‚úÖ <strong>${result.items_count}</strong> ta item import qilindi</p>\r\n                                        <p>üí∞ Jami: <strong>${format_currency(result.total_amount, 'UZS')}</strong></p>\r\n                                        <hr>\r\n                                        <p><a href=\"/app/sales-invoice/${result.sales_invoice}\">\r\n                                            üìÑ Sales Invoice: ${result.sales_invoice}\r\n                                        </a></p>\r\n                                        ${result.stock_entry ? `\r\n                                        <p><a href=\"/app/stock-entry/${result.stock_entry}\">\r\n                                            üì¶ Stock Entry: ${result.stock_entry}\r\n                                        </a></p>\r\n                                        ` : ''}\r\n                                    `\r\n                                });\r\n                                \r\n                                frm.reload_doc();\r\n                            } else {\r\n                                frappe.msgprint({\r\n                                    title: __('Import xatosi'),\r\n                                    indicator: 'red',\r\n                                    message: result.message\r\n                                });\r\n                                frm.reload_doc();\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            },\r\n            function() {\r\n                // On No - do nothing\r\n            }\r\n        );\r\n    },\r\n    \r\n    cancel_import: function(frm) {\r\n        frappe.confirm(\r\n            __('Import bekor qilinsinmi? Sales Invoice va Stock Entry ham bekor qilinadi.'),\r\n            function() {\r\n                frappe.call({\r\n                    method: 'restaurant.restaurant.doctype.restaurant_daily_sales_import.restaurant_daily_sales_import.cancel_import',\r\n                    args: {\r\n                        doc_name: frm.doc.name\r\n                    },\r\n                    freeze: true,\r\n                    freeze_message: __('Bekor qilinmoqda...'),\r\n                    callback: function(r) {\r\n                        if (r.message) {\r\n                            if (r.message.success) {\r\n                                frappe.show_alert({\r\n                                    message: __('Import bekor qilindi'),\r\n                                    indicator: 'green'\r\n                                });\r\n                            } else {\r\n                                frappe.msgprint({\r\n                                    title: __('Xato'),\r\n                                    indicator: 'red',\r\n                                    message: r.message.message\r\n                                });\r\n                            }\r\n                            frm.reload_doc();\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        );\r\n    }\r\n});",
  "view": "Form"
 }
]