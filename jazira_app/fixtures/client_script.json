[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Jazira App Daily Sales Import",
  "enabled": 1,
  "modified": "2026-01-04 17:30:27.579664",
  "module": "Jazira App",
  "name": "Jazira App Daily Sales Import",
  "script": "frappe.ui.form.on('Jazira App Daily Sales Import', {\n    \n    refresh: function(frm) {\n        frm.trigger('setup_buttons');\n        frm.trigger('setup_realtime');\n        frm.trigger('show_status_indicator');\n        frm.trigger('set_warehouse_filter');\n        frm.trigger('validate_prerequisites');\n        frm.trigger('format_stock_entry_links');\n    },\n    \n    // =========================================================================\n    // FORMAT STOCK ENTRY LINKS\n    // =========================================================================\n    \n    format_stock_entry_links: function(frm) {\n        if (frm.doc.stock_entry && frm.doc.status === 'Processed') {\n            let se_names = frm.doc.stock_entry.split(',').map(s => s.trim()).filter(s => s);\n            \n            if (se_names.length > 0) {\n                let links_html = se_names.map(se_name => \n                    `<a href=\"/app/stock-entry/${se_name}\" style=\"margin-right: 10px;\">${se_name}</a>`\n                ).join('<br>');\n                \n                // Update the field display\n                setTimeout(() => {\n                    let field_wrapper = frm.fields_dict.stock_entry.$wrapper;\n                    let control_value = field_wrapper.find('.like-disabled-input, .control-value');\n                    if (control_value.length) {\n                        control_value.html(links_html);\n                    }\n                }, 100);\n            }\n        }\n    },\n    \n    // =========================================================================\n    // COMPANY CHANGE - Auto-fill warehouse\n    // =========================================================================\n    \n    company: function(frm) {\n        if (!frm.doc.company) {\n            frm.set_value('source_warehouse', '');\n            return;\n        }\n        \n        // Check if current warehouse belongs to new company\n        if (frm.doc.source_warehouse) {\n            frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'Warehouse',\n                    fieldname: 'company',\n                    filters: { name: frm.doc.source_warehouse }\n                },\n                callback: function(r) {\n                    if (r.message && r.message.company !== frm.doc.company) {\n                        // Warehouse belongs to different company - replace\n                        frappe.show_alert({\n                            message: __('Warehouse boshqa kompaniyaga tegishli. Yangilanmoqda...'),\n                            indicator: 'orange'\n                        });\n                        frm.trigger('set_default_warehouse');\n                    }\n                }\n            });\n        } else {\n            // No warehouse set - get default\n            frm.trigger('set_default_warehouse');\n        }\n        \n        frm.trigger('set_warehouse_filter');\n    },\n    \n    set_default_warehouse: function(frm) {\n        frappe.call({\n            method: 'jazira_app.jazira_app.doctype.jazira_app_daily_sales_import.jazira_app_daily_sales_import.get_default_warehouse',\n            args: { company: frm.doc.company },\n            callback: function(r) {\n                if (r.message && r.message.source_warehouse) {\n                    frm.set_value('source_warehouse', r.message.source_warehouse);\n                    frappe.show_alert({\n                        message: __('Default warehouse: {0}', [r.message.source_warehouse]),\n                        indicator: 'green'\n                    });\n                }\n            }\n        });\n    },\n    \n    source_warehouse: function(frm) {\n        frm.trigger('validate_prerequisites');\n    },\n    \n    posting_date: function(frm) {\n        frm.trigger('validate_prerequisites');\n    },\n    \n    excel_file: function(frm) {\n        if (frm.doc.excel_file) {\n            frm.trigger('on_excel_uploaded');\n        }\n    },\n    \n    // =========================================================================\n    // WAREHOUSE FILTER\n    // =========================================================================\n    \n    set_warehouse_filter: function(frm) {\n        frm.set_query('source_warehouse', function() {\n            return {\n                filters: {\n                    'company': frm.doc.company || '',\n                    'is_group': 0\n                }\n            };\n        });\n    },\n    \n    // =========================================================================\n    // VALIDATION\n    // =========================================================================\n    \n    validate_prerequisites: function(frm) {\n        let valid = frm.doc.company && \n                    frm.doc.source_warehouse && \n                    frm.doc.posting_date;\n        \n        if (!valid) {\n            frm.set_df_property('excel_file', 'read_only', 1);\n            frm.set_df_property('excel_file', 'description', \n                '<span style=\"color: red;\">‚ö†Ô∏è Avval Company, Oshxona Ombori va Posting Date tanlang!</span>');\n        } else {\n            frm.set_df_property('excel_file', 'read_only', 0);\n            frm.set_df_property('excel_file', 'description', \n                'POS hisoboti Excel fayli (.xlsx)');\n        }\n    },\n    \n    on_excel_uploaded: function(frm) {\n        if (frm.doc.status !== 'Draft') {\n            frappe.msgprint(__('Import allaqachon bajarilgan'));\n            return;\n        }\n        \n        frm.save().then(() => {\n            frm.trigger('show_preview');\n        });\n    },\n    \n    // =========================================================================\n    // BUTTONS\n    // =========================================================================\n    \n    setup_buttons: function(frm) {\n        frm.clear_custom_buttons();\n        \n        if (frm.doc.status === 'Draft') {\n            if (frm.doc.excel_file) {\n                frm.add_custom_button(__('üìã Preview'), function() {\n                    frm.trigger('show_preview');\n                }, __('Actions'));\n                \n                frm.add_custom_button(__('‚úì Validate'), function() {\n                    frm.trigger('validate_items');\n                }, __('Actions'));\n                \n                frm.add_custom_button(__('‚ñ∂ Process Import'), function() {\n                    frm.trigger('process_import');\n                }).addClass('btn-primary');\n            }\n        }\n        \n        if (frm.doc.status === 'Processed') {\n            frm.add_custom_button(__('‚úï Cancel Import'), function() {\n                frm.trigger('cancel_import');\n            }).addClass('btn-danger');\n            \n            if (frm.doc.stock_entry) {\n                // Multiple Stock Entries - show dropdown or first one\n                let se_names = frm.doc.stock_entry.split(',').map(s => s.trim()).filter(s => s);\n                \n                if (se_names.length === 1) {\n                    frm.add_custom_button(__('Manufacture SE'), function() {\n                        frappe.set_route('Form', 'Stock Entry', se_names[0]);\n                    }, __('View'));\n                } else if (se_names.length > 1) {\n                    // Multiple - add dropdown\n                    se_names.forEach((se_name, idx) => {\n                        frm.add_custom_button(__(`Manufacture ${idx + 1}`), function() {\n                            frappe.set_route('Form', 'Stock Entry', se_name);\n                        }, __('Manufacture SEs'));\n                    });\n                }\n            }\n            \n            if (frm.doc.sales_invoice) {\n                frm.add_custom_button(__('Sales Invoice'), function() {\n                    frappe.set_route('Form', 'Sales Invoice', frm.doc.sales_invoice);\n                }, __('View'));\n            }\n        }\n        \n        if (frm.doc.status === 'Failed') {\n            frm.add_custom_button(__('üîÑ Retry'), function() {\n                frm.set_value('status', 'Draft');\n                frm.set_value('error_log', '');\n                frm.set_value('import_log', '');\n                frm.save().then(() => {\n                    frm.trigger('process_import');\n                });\n            }).addClass('btn-warning');\n        }\n    },\n    \n    show_status_indicator: function(frm) {\n        let status_colors = {\n            'Draft': 'blue',\n            'Processing': 'orange',\n            'Processed': 'green',\n            'Failed': 'red'\n        };\n        \n        let color = status_colors[frm.doc.status] || 'gray';\n        frm.page.set_indicator(__(frm.doc.status), color);\n    },\n    \n    setup_realtime: function(frm) {\n        frappe.realtime.on('restaurant_import_success', function(data) {\n            if (data.doc_name === frm.doc.name) {\n                frappe.show_alert({\n                    message: __('Import muvaffaqiyatli bajarildi!'),\n                    indicator: 'green'\n                });\n                frm.reload_doc();\n            }\n        });\n        \n        frappe.realtime.on('restaurant_import_failed', function(data) {\n            if (data.doc_name === frm.doc.name) {\n                frappe.msgprint({\n                    title: __('Import xatosi'),\n                    indicator: 'red',\n                    message: data.error || data.result?.message\n                });\n                frm.reload_doc();\n            }\n        });\n    },\n    \n    // =========================================================================\n    // ACTIONS\n    // =========================================================================\n    \n    show_preview: function(frm) {\n        frappe.call({\n            method: 'jazira_app.jazira_app.doctype.jazira_app_daily_sales_import.jazira_app_daily_sales_import.get_preview_data',\n            args: { doc_name: frm.doc.name },\n            freeze: true,\n            freeze_message: __('Excel o\\'qilmoqda...'),\n            callback: function(r) {\n                if (r.message && r.message.success) {\n                    frm.trigger('render_preview_dialog', r.message);\n                } else {\n                    frappe.msgprint({\n                        title: __('Xato'),\n                        indicator: 'red',\n                        message: r.message ? r.message.message : __('Preview yuklashda xato')\n                    });\n                }\n            }\n        });\n    },\n    \n    render_preview_dialog: function(frm, data) {\n        let items = data.items || [];\n        let summary = data.summary || {};\n        \n        let rows_html = items.map((item, idx) => {\n            let type_badge = '';\n            if (!item.found) {\n                type_badge = '<span class=\"badge badge-danger\">NOT FOUND</span>';\n            } else if (item.has_bom) {\n                type_badge = '<span class=\"badge badge-primary\">MANUFACTURE</span>';\n            } else {\n                type_badge = '<span class=\"badge badge-secondary\">DIRECT SALE</span>';\n            }\n            \n            let bom_info = item.bom ? `<br><small class=\"text-muted\">${item.bom}</small>` : '';\n            \n            return `\n                <tr class=\"${item.found ? '' : 'table-danger'}\">\n                    <td>${idx + 1}</td>\n                    <td>${item.row_num}</td>\n                    <td>${item.item_name}${bom_info}</td>\n                    <td>${item.item_code || '-'}</td>\n                    <td class=\"text-right\">${item.qty}</td>\n                    <td class=\"text-right\">${format_currency(item.rate, 'UZS')}</td>\n                    <td class=\"text-right\">${format_currency(item.qty * item.rate, 'UZS')}</td>\n                    <td>${type_badge}</td>\n                </tr>\n            `;\n        }).join('');\n        \n        let dialog = new frappe.ui.Dialog({\n            title: __('Excel Preview - Bitta Ombor Workflow'),\n            size: 'extra-large',\n            fields: [{ fieldtype: 'HTML', fieldname: 'preview_html' }]\n        });\n        \n        let html = `\n            <div class=\"mb-4\">\n                <div class=\"row\">\n                    <div class=\"col-md-2\">\n                        <div class=\"card bg-primary text-white text-center p-2\">\n                            <h4 class=\"mb-0\">${summary.total_items || 0}</h4>\n                            <small>Jami</small>\n                        </div>\n                    </div>\n                    <div class=\"col-md-2\">\n                        <div class=\"card bg-success text-white text-center p-2\">\n                            <h4 class=\"mb-0\">${summary.found || 0}</h4>\n                            <small>Topildi</small>\n                        </div>\n                    </div>\n                    <div class=\"col-md-2\">\n                        <div class=\"card bg-danger text-white text-center p-2\">\n                            <h4 class=\"mb-0\">${summary.not_found || 0}</h4>\n                            <small>Topilmadi</small>\n                        </div>\n                    </div>\n                    <div class=\"col-md-3\">\n                        <div class=\"card bg-info text-white text-center p-2\">\n                            <h4 class=\"mb-0\">${summary.with_bom || 0}</h4>\n                            <small>BOM (Manufacture)</small>\n                        </div>\n                    </div>\n                    <div class=\"col-md-3\">\n                        <div class=\"card bg-secondary text-white text-center p-2\">\n                            <h4 class=\"mb-0\">${summary.without_bom || 0}</h4>\n                            <small>No BOM (Direct)</small>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class=\"alert alert-success\">\n                <strong>üè™ Bitta Ombor Workflow:</strong><br>\n                <span class=\"text-muted\">Hammasi <strong>${frm.doc.source_warehouse}</strong> omborida:</span><br>\n                1Ô∏è‚É£ <strong>Manufacture:</strong> Xomashyo (‚àí) ‚Üí Tayyor mahsulot (+)<br>\n                2Ô∏è‚É£ <strong>Sales Invoice:</strong> Tayyor mahsulot (‚àí) [Update Stock ON]\n            </div>\n            \n            <div class=\"mb-3\">\n                <strong>üí∞ Jami summa:</strong> ${format_currency(summary.total_amount || 0, 'UZS')}\n            </div>\n            \n            <div class=\"table-responsive\" style=\"max-height: 350px; overflow-y: auto;\">\n                <table class=\"table table-sm table-bordered table-hover\">\n                    <thead class=\"thead-dark\" style=\"position: sticky; top: 0;\">\n                        <tr>\n                            <th>#</th>\n                            <th>Row</th>\n                            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>\n                            <th>Item Code</th>\n                            <th class=\"text-right\">Qty</th>\n                            <th class=\"text-right\">Rate</th>\n                            <th class=\"text-right\">Amount</th>\n                            <th>Type</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        ${rows_html}\n                    </tbody>\n                </table>\n            </div>\n        `;\n        \n        dialog.fields_dict.preview_html.$wrapper.html(html);\n        dialog.show();\n    },\n    \n    validate_items: function(frm) {\n        frappe.call({\n            method: 'jazira_app.jazira_app.doctype.jazira_app_daily_sales_import.jazira_app_daily_sales_import.validate_excel_items',\n            args: { doc_name: frm.doc.name },\n            freeze: true,\n            freeze_message: __('Tekshirilmoqda...'),\n            callback: function(r) {\n                if (r.message) {\n                    let data = r.message;\n                    \n                    if (data.success) {\n                        frappe.msgprint({\n                            title: __('‚úÖ Validation Success'),\n                            indicator: 'green',\n                            message: `\n                                <p><strong>${data.items.length}</strong> ta item topildi</p>\n                                <p>Jami: <strong>${format_currency(data.total_amount, 'UZS')}</strong></p>\n                            `\n                        });\n                    } else {\n                        let errors_html = (data.errors || []).map(e => \n                            `<li><strong>Qator ${e.row}:</strong> ${e.error}</li>`\n                        ).join('');\n                        \n                        frappe.msgprint({\n                            title: __('‚ùå Validation Errors'),\n                            indicator: 'red',\n                            message: `<ul>${errors_html}</ul>`\n                        });\n                    }\n                }\n            }\n        });\n    },\n    \n    process_import: function(frm) {\n        let workflow_info = `\n            <div class=\"alert alert-success mb-3\">\n                <strong>üè™ Bitta Ombor Workflow:</strong><br>\n                1Ô∏è‚É£ BOM li ‚Üí Manufacture (${frm.doc.source_warehouse})<br>\n                2Ô∏è‚É£ Barcha ‚Üí Sales Invoice (Update Stock ON)\n            </div>\n        `;\n        \n        frappe.confirm(\n            __(`Import bajarilsinmi?<br><br>\n                <strong>Company:</strong> ${frm.doc.company}<br>\n                <strong>Ombor:</strong> ${frm.doc.source_warehouse}<br>\n                <strong>Sana:</strong> ${frm.doc.posting_date}<br><br>\n                ${workflow_info}\n            `),\n            function() {\n                frappe.call({\n                    method: 'jazira_app.jazira_app.doctype.jazira_app_daily_sales_import.jazira_app_daily_sales_import.process_import',\n                    args: {\n                        doc_name: frm.doc.name,\n                        background: false\n                    },\n                    freeze: true,\n                    freeze_message: __('Import jarayoni... (Manufacture ‚Üí Sales Invoice)'),\n                    callback: function(r) {\n                        if (r.message) {\n                            let result = r.message;\n                            \n                            if (result.success) {\n                                frappe.show_alert({\n                                    message: __('Import muvaffaqiyatli!'),\n                                    indicator: 'green'\n                                });\n                                \n                                // Build Stock Entries links\n                                let stock_entries_html = '';\n                                if (result.stock_entries && result.stock_entries.length > 0) {\n                                    stock_entries_html = result.stock_entries.map((se, idx) => \n                                        `<p>üè≠ <a href=\"/app/stock-entry/${se}\">Manufacture ${idx + 1}: ${se}</a></p>`\n                                    ).join('');\n                                } else {\n                                    stock_entries_html = '<p><em>Manufacture yaratilmadi (BOM yo\\'q)</em></p>';\n                                }\n                                \n                                frappe.msgprint({\n                                    title: __('‚úÖ Import natijasi'),\n                                    indicator: 'green',\n                                    message: `\n                                        <p>‚úÖ <strong>${result.total_items}</strong> ta item import qilindi</p>\n                                        <p>üè≠ BOM bilan (Manufacture): <strong>${result.items_with_bom}</strong></p>\n                                        <p>üì¶ BOMsiz (Direct Sale): <strong>${result.items_without_bom}</strong></p>\n                                        <p>üí∞ Jami: <strong>${format_currency(result.total_amount, 'UZS')}</strong></p>\n                                        <hr>\n                                        ${stock_entries_html}\n                                        <p>üìÑ <a href=\"/app/sales-invoice/${result.sales_invoice}\">Sales Invoice: ${result.sales_invoice}</a></p>\n                                    `\n                                });\n                                \n                                frm.reload_doc();\n                            } else {\n                                frappe.msgprint({\n                                    title: __('‚ùå Import xatosi'),\n                                    indicator: 'red',\n                                    message: result.message\n                                });\n                                frm.reload_doc();\n                            }\n                        }\n                    }\n                });\n            }\n        );\n    },\n    \n    cancel_import: function(frm) {\n        let se_info = frm.doc.stock_entry || 'N/A';\n        let se_count = frm.doc.stock_entry ? frm.doc.stock_entry.split(',').length : 0;\n        \n        frappe.confirm(\n            __(`Import bekor qilinsinmi?<br><br>\n                <strong>Bekor qilinadigan hujjatlar:</strong><br>\n                üìÑ Sales Invoice: ${frm.doc.sales_invoice || 'N/A'}<br>\n                üè≠ Stock Entries (${se_count} ta): ${se_info}\n            `),\n            function() {\n                frappe.call({\n                    method: 'jazira_app.jazira_app.doctype.jazira_app_daily_sales_import.jazira_app_daily_sales_import.cancel_import',\n                    args: { doc_name: frm.doc.name },\n                    freeze: true,\n                    freeze_message: __('Bekor qilinmoqda...'),\n                    callback: function(r) {\n                        if (r.message) {\n                            if (r.message.success) {\n                                frappe.show_alert({\n                                    message: __('Import bekor qilindi'),\n                                    indicator: 'green'\n                                });\n                            } else {\n                                frappe.msgprint({\n                                    title: __('Xato'),\n                                    indicator: 'red',\n                                    message: r.message.message\n                                });\n                            }\n                            frm.reload_doc();\n                        }\n                    }\n                });\n            }\n        );\n    }\n});",
  "view": "Form"
 }
]